package net.iceyleagons.icicle.core.modules;

import lombok.*;
import net.iceyleagons.icicle.core.utils.Version;
import net.iceyleagons.icicle.utilities.Asserts;
import org.simpleyaml.configuration.file.YamlFile;

import java.io.File;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;
import java.util.jar.JarEntry;
import java.util.jar.JarFile;
import java.util.stream.Collectors;

@EqualsAndHashCode
@RequiredArgsConstructor
@Getter
public class ModuleMetadata {

    @NonNull
    private final File baseFile;
    @NonNull
    private final String name;
    @NonNull
    private final String description;
    @NonNull
    private final DependencyNotation dependencyNotation;
    @NonNull
    private final String mainClass;
    @NonNull
    private final Version version;
    @NonNull
    private final List<String> developers;
    @NonNull
    private final List<DependencyNotation> dependencies;

    // private static final List<ModuleMetadata> loadedModules = new ArrayList<>();

    public ModuleMetadata(InputStream inputStream, File file) {
        val yamlFile = YamlFile.loadConfiguration(inputStream);

        // Required stuff...
        val name = yamlFile.getString("name");
        val dependencyNotation = yamlFile.getString("dependency-notation");
        val mainClass = yamlFile.getString("main-class");
        val description = yamlFile.getString("description");
        val version = new Version(yamlFile.getString("version"));

        var dependencies = yamlFile.getStringList("dependencies");
        if (dependencies == null)
            dependencies = new ArrayList<>();
        // Commented out since load order isn't defined here.
        /*if (dependencies != null) {
            // Check if dependency is installed/has correct version.
            if (!dependencies.stream().allMatch(dependency -> {
                val splitDependency = dependency.split(":");
                val dependencyName = splitDependency[1];
                val dependencyVersion = new Version(splitDependency[2]);

                for (ModuleMetadata loadedDependency : loadedModules)
                    if (loadedDependency.name.equalsIgnoreCase(dependencyName))
                        if (loadedDependency.version.compareTo(dependencyVersion) >= 0)
                            return true;

                return false;
            }))
                throw new IllegalArgumentException("Required dependencies not found!");
        }*/

        var developers = yamlFile.getStringList("developers");
        if (developers == null)
            developers = new ArrayList<>();

        this.baseFile = file;
        this.name = name;
        this.version = version;
        this.developers = developers;
        this.description = description;
        this.dependencies = dependencies.stream().map(DependencyNotation::fromString).collect(Collectors.toUnmodifiableList());
        this.dependencyNotation = DependencyNotation.fromString(dependencyNotation);
        this.mainClass = mainClass;
    }

    @SneakyThrows
    public static ModuleMetadata fromFile(File file) {
        Asserts.notNull(file, "File must not be null!");

        try (JarFile jarFile = new JarFile(file)) {
            JarEntry metaEntry = jarFile.getJarEntry("icicle.yml");

            if (metaEntry == null || metaEntry.isDirectory())
                throw new IllegalStateException("icicle.yml file is not found or is a directory!");

            try (InputStream inputStream = jarFile.getInputStream(metaEntry)) {
                return new ModuleMetadata(inputStream, file);
            }
        }
    }
}
